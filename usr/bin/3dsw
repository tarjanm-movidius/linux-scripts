#!/bin/sh

X11_BIN_DIR="/usr/bin/X11"
D3D_DIR="/usr/local/bin"
LOCKFILE="/var/lock/3dsw/3doff"

runtest()
{
   if test -z "`ps ax | grep -e $1 | grep -v grep`"; then
	return 1
   else
	return 0
   fi
}

s3d_test()
{
   if test -e $LOCKFILE -o "$DISPLAY" != ":0.0"; then
	return 1
   else
	return 0
   fi
}

s3d_init()
{
   if test -d `dirname $LOCKFILE`; then
	keys_file_init
	if s3d_test; then
	  cat $HOME/.fluxbox/keys.3d >> $HOME/.fluxbox/keys
	else
	  cat $HOME/.fluxbox/keys.2d >> $HOME/.fluxbox/keys
	fi
   else
	rm -f `dirname $LOCKFILE`
	mkdir -p `dirname $LOCKFILE`
	chmod 777 `dirname $LOCKFILE`
   fi
}

keys_file_init()
{
   if test -z "$HOME"; then
	echo "Error finding home directory! Dumb terminal?" 1>&2
	exit 1
   fi
   if ! test -e $HOME/.fluxbox/keys.base -a -e $HOME/.fluxbox/keys.2d -a -e $HOME/.fluxbox/keys.3d; then
	echo "Error finding keys.base/keys.2d/keys.3d in ~/.fluxbox!" 1>&2
	exit 1
   fi
   mv -f $HOME/.fluxbox/keys $HOME/.fluxbox/keys~
   echo "!            *** Fluxbox keys file ***" > $HOME/.fluxbox/keys
   echo "! Automatically generated by `basename $0`, do not edit manually!" >> $HOME/.fluxbox/keys
   echo "! Edit keys.base/keys.2d/keys.3d instead & run `basename $0` init" >> $HOME/.fluxbox/keys
   echo "" >> $HOME/.fluxbox/keys
   cat $HOME/.fluxbox/keys.base >> $HOME/.fluxbox/keys
}

s3d_on()
{
   if ! runtest "3ddesk"; then
	echo -n "Starting 3ddesk ..."
	rm -f ~/.3ddesktop/pid
	$D3D_DIR/3ddeskd --wm=fluxbox --acquire=350 >/dev/null 2>&1
	echo " Done"
   fi
   if ! runtest "xscreensaver"; then
	echo -n "Starting XScreenSaver ..."
        $X11_BIN_DIR/xscreensaver -nosplash &
	echo " Done"
   fi

   keys_file_init
   cat $HOME/.fluxbox/keys.3d >> $HOME/.fluxbox/keys
   killall -HUP fluxbox

   if ! s3d_test; then
	echo -n "Lockfile "
	rm -vf $LOCKFILE
   fi
}

s3d_off()
{
   keys_file_init
   cat $HOME/.fluxbox/keys.2d >> $HOME/.fluxbox/keys
   killall -HUP fluxbox

   if s3d_test; then
	echo -n "Creating lockfile \`$LOCKFILE' ..."
	touch $LOCKFILE
	chmod 666 $LOCKFILE
	echo " Done"
   fi

   if runtest "3ddesk"; then
	echo -n "Stopping 3ddesk ..."
	$D3D_DIR/3ddesk --stop >/dev/null 2>&1
	echo " Done"
   fi
   if runtest "xscreensaver"; then
	echo -n "Stopping XScreenSaver ..."
	$X11_BIN_DIR/xscreensaver-command -exit >/dev/null 2>&1
    	echo " Done"
   fi
}

case "$1" in
'on')
  s3d_on
  ;;
'off')
  s3d_off
  ;;
'test')
  s3d_test
  ;;
'init')
  s3d_init
  ;;
*)
  echo "Usage: `basename $0` on|off|test|init"
esac
