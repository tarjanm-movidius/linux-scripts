#!/bin/sh

# M4A/MP3/MPC/OGG/WMA converter file generator
version="0.6.6"

if [ "$1" = "--version" ]; then
      echo ""
      echo "$(basename "$0") - AAC/FLAC/M4A/MP3/MPC/OGG/WMA to MP3 converter file generator version ${version}"
      echo ""
      exit 0
fi
if [ "$1" = "-160" -o "$1" = "-192" -o "$1" = "--160" -o "$1" = "--192" ]; then
      BITRATE=$(tr -d '-' <<< $1)
      shift
else
      BITRATE=128
fi
# --- Checking proper parameter usage ---
if [ $# -eq 0 ]; then
      echo ""
      echo "Usage: $(basename "$0") < --version | < [-160 | -192] file(s) to convert > >" 1>&2
      echo ""
      exit 1
fi

# --- Initial commands ---
chmod 644 *
chmod +X *
mv cvt cvt.old > /dev/null 2>&1

# --- cvt Header ---
echo "#!/bin/sh" > cvt
echo "" >> cvt
echo "#########################################################################" >> cvt
echo "# cvt - AAC/FLAC/M4A/MP3/MPC/OGG/WMA Converter generated by $(basename "$0") ${version} #" >> cvt
echo "#########################################################################" >> cvt
echo "" >> cvt

# --- cvt Conversion variables ---
echo "QUALITY=1" >> cvt
echo "BITRATE=$BITRATE" >> cvt
echo "MODE=j" >> cvt
echo "TARGETPATH=\$BITRATE" >> cvt
echo "" >> cvt

# --- cvt Initial commands ---
echo "mkdir -vp \"\$TARGETPATH\"" >> cvt
if test -e audiodump.wav; then
    echo "mv -vf audiodump.wav audiodump_old.wav" >> cvt
fi
    echo "" >> cvt

# --- cvt Adding files ---
while test $# -gt 0; do
  case $1 in
    *.[Mm][Pp]3)
      echo "lame -p -b \$BITRATE -m \$MODE -q \$QUALITY \"$1\" \"\$TARGETPATH/$1\"" >> cvt
      ;;
    *.[Ww][Mm][Aa]|*.[Oo][Gg][Gg]|*.[Mm][24][Aa]|*.[Mm][Pp]4|*.[Aa][Aa][Cc]|*.[Ff][Ll][Aa][Cc])
      echo "echo \"\";echo \"Decoding '$1'...\"" >> cvt
      echo "mplayer -af resample=44100:0:2 -vo null -vc null -ao pcm:fast \"$1\" > /dev/null" >> cvt
      echo "lame -p -b \$BITRATE -m \$MODE -q \$QUALITY audiodump.wav \"\$TARGETPATH/$1.mp3\"" | rev | cut -d '.' -f 1,3- - | rev >> cvt
      echo "rm -f audiodump.wav > /dev/null 2>&1" >> cvt
      ;;
    *.[Mm][Pp][Cc])
      echo "echo \"\";echo \"Decoding '$1'...\"" >> cvt
      if [ -n "`which mppdec`" ]; then
        echo "mppdec \"$1\" audiodump.wav > /dev/null" >> cvt
      else
        echo "mplayer -af resample=44100:0:2 -vo null -vc null -ao pcm \"$1\" > /dev/null" >> cvt
      fi
      echo "lame -p -b \$BITRATE -m \$MODE -q \$QUALITY audiodump.wav \"\$TARGETPATH/$1.mp3\"" | rev | cut -d '.' -f 1,3- - | rev >> cvt
      echo "rm -f audiodump.wav > /dev/null 2>&1" >> cvt
      ;;
    *)
      echo "Excluding file: $1"
      ;;
  esac
  shift
done
echo "" >> cvt

# --- cvt Terminal commands ---
if test -e audiodump_old.wav; then
    echo "mv -vf audiodump_old.wav audiodump.wav" >> cvt
fi
echo "#halt" >> cvt

# --- Terminal commands ---
chmod 755 cvt
grep -e \` cvt 1>&2

